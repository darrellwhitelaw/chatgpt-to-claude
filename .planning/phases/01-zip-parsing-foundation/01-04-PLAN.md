---
phase: 01-zip-parsing-foundation
plan: "04"
type: execute
wave: 3
depends_on:
  - 01-02
  - 01-03
files_modified:
  - src/App.tsx
  - src/components/DropZone.tsx
  - src/components/ProgressView.tsx
  - src/components/SummaryCard.tsx
  - src/hooks/useIngest.ts
  - src/store/appStore.ts
autonomous: false
requirements:
  - IMP-01
  - IMP-02
  - IMP-03

must_haves:
  truths:
    - "User can drag a ZIP file onto the centered drop zone and see it begin processing without clicking anything"
    - "Drop zone has a dashed border, a centered icon, and the single line 'Drop your ChatGPT export here'"
    - "User can click 'Browse' inside the drop zone to open a native macOS file picker filtered to .zip files"
    - "While processing, user sees stage labels with a spinner — no byte counts, no file paths, no technical jargon"
    - "Stage labels cycle: 'Extracting ZIP...' → 'Parsing conversations...' → 'Building index...'"
    - "After parsing completes, user sees 'Found [N] conversations ([year] – [year])' summary card with a Continue button"
    - "If an error occurs (invalid ZIP, missing conversations.json), an inline error message appears and the drop zone resets"
    - "The UI is always light — white background, no dark mode"
  artifacts:
    - path: "src/components/DropZone.tsx"
      provides: "Drop zone UI — dashed border, icon, 'Drop your ChatGPT export here', Browse link inside zone"
      min_lines: 60
    - path: "src/components/ProgressView.tsx"
      provides: "Stage label + spinner — no byte counts; three stage strings from IngestEvent"
      min_lines: 30
    - path: "src/components/SummaryCard.tsx"
      provides: "Summary card — 'Found N conversations (YYYY – YYYY)' + Continue button"
      min_lines: 25
    - path: "src/hooks/useIngest.ts"
      provides: "useIngest hook — invoke('parse_zip'), Channel<IngestEvent>, drives store state transitions"
      exports: ["useIngest"]
    - path: "src/store/appStore.ts"
      provides: "Zustand store — idle | parsing | complete | error state machine"
      exports: ["useAppStore"]
    - path: "src/App.tsx"
      provides: "State machine rendering: idle→DropZone, parsing→ProgressView, complete→SummaryCard"
      min_lines: 30
  key_links:
    - from: "src/components/DropZone.tsx"
      to: "src/hooks/useIngest.ts"
      via: "startIngest(zipPath) called on drop event payload.paths and on file picker result"
      pattern: "startIngest"
    - from: "src/hooks/useIngest.ts"
      to: "invoke('parse_zip', { path, onEvent })"
      via: "Channel<IngestEvent> onmessage drives useAppStore state transitions"
      pattern: "invoke.*parse_zip"
    - from: "src/components/DropZone.tsx"
      to: "getCurrentWindow().onDragDropEvent()"
      via: "Tauri native drop event — NOT HTML5 onDrop (HTML5 does not provide file paths)"
      pattern: "onDragDropEvent"
---

<objective>
Build the complete React import UI: drop zone with Tauri native drag-and-drop, file picker fallback, three-stage progress display, and a completion summary card. The UI is the user-facing half of the Phase 1 pipeline — it drives the Rust `parse_zip` command and renders its progress events.

Purpose: IMP-01 (drag-and-drop), IMP-02 (file picker), and IMP-03 (progress bar) all land in this plan. Without this, the pipeline exists but is invisible to the user.
Output: A working macOS app UI that accepts ZIP files two ways, shows human-readable progress, and displays the conversation count and year range on completion.
</objective>

<execution_context>
@/Users/darrellwhitelaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/darrellwhitelaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-zip-parsing-foundation/01-CONTEXT.md
@.planning/phases/01-zip-parsing-foundation/01-RESEARCH.md
@.planning/phases/01-zip-parsing-foundation/01-01-SUMMARY.md
@.planning/phases/01-zip-parsing-foundation/01-02-SUMMARY.md
@.planning/phases/01-zip-parsing-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Zustand store, useIngest hook, and App state machine</name>
  <files>
    src/store/appStore.ts
    src/hooks/useIngest.ts
    src/App.tsx
  </files>
  <action>
**`src/store/appStore.ts`** — Zustand state machine for the import flow:

```typescript
import { create } from 'zustand';

export type AppPhase = 'idle' | 'parsing' | 'complete' | 'error';

export interface Summary {
  total: number;
  earliestYear: number;
  latestYear: number;
}

interface AppState {
  phase: AppPhase;
  stage: string;          // Human-readable current stage label
  error: string | null;
  summary: Summary | null;

  setStage: (stage: string) => void;
  setError: (msg: string) => void;
  setComplete: (summary: Summary) => void;
  reset: () => void;
}

export const useAppStore = create<AppState>((set) => ({
  phase: 'idle',
  stage: '',
  error: null,
  summary: null,

  setStage: (stage) => set({ phase: 'parsing', stage, error: null }),
  setError: (msg) => set({ phase: 'error', error: msg }),
  setComplete: (summary) => set({ phase: 'complete', summary }),
  reset: () => set({ phase: 'idle', stage: '', error: null, summary: null }),
}));
```

**`src/hooks/useIngest.ts`** — invokes `parse_zip` and drives store transitions:

```typescript
import { invoke, Channel } from '@tauri-apps/api/core';
import type { IngestEvent } from '../lib/bindings';
import { useAppStore } from '../store/appStore';

export function useIngest() {
  const { setStage, setError, setComplete } = useAppStore();

  const startIngest = async (zipPath: string) => {
    const onEvent = new Channel<IngestEvent>();

    onEvent.onmessage = (msg) => {
      switch (msg.event) {
        case 'started':
          setStage('Starting...');
          break;
        case 'extractingZip':
          setStage('Extracting ZIP...');
          break;
        case 'parsingConversations':
          setStage('Parsing conversations...');
          break;
        case 'buildingIndex':
          setStage('Building index...');
          break;
        case 'complete':
          setComplete({
            total: msg.data.total,
            earliestYear: msg.data.earliestYear,
            latestYear: msg.data.latestYear,
          });
          break;
        case 'error':
          setError(msg.data.message);
          break;
      }
    };

    try {
      await invoke('parse_zip', { path: zipPath, onEvent });
    } catch (err) {
      setError(err instanceof Error ? err.message : String(err));
    }
  };

  return { startIngest };
}
```

**`src/App.tsx`** — renders the active phase:

```typescript
import { useAppStore } from './store/appStore';
import { DropZone } from './components/DropZone';
import { ProgressView } from './components/ProgressView';
import { SummaryCard } from './components/SummaryCard';

export default function App() {
  const { phase, stage, error, summary, reset } = useAppStore();

  return (
    <div className="h-screen w-screen bg-white flex items-center justify-center">
      {phase === 'idle' && <DropZone />}
      {phase === 'parsing' && <ProgressView stage={stage} />}
      {phase === 'error' && <DropZone errorMessage={error ?? undefined} onReset={reset} />}
      {phase === 'complete' && summary && (
        <SummaryCard
          total={summary.total}
          earliestYear={summary.earliestYear}
          latestYear={summary.latestYear}
          onContinue={() => {
            // Phase 2 navigation wired here in the next phase
            console.log('Continue clicked — Phase 2 entry point');
          }}
        />
      )}
    </div>
  );
}
```

Note: `h-screen w-screen` fills the Tauri window's usable content area (500px after title bar). Light white background — always light per locked decisions.
  </action>
  <verify>
    <automated>cd /Users/darrellwhitelaw/Claude/chatgpt-to-claude && pnpm tsc --noEmit 2>&1 | grep "error TS" | head -10</automated>
    <manual>Zero TypeScript errors</manual>
  </verify>
  <done>
    - `useAppStore` exposes `phase`, `stage`, `error`, `summary`, `setStage`, `setError`, `setComplete`, `reset`
    - `useIngest` returns `startIngest(zipPath: string)` — invokes `parse_zip` and maps all 6 IngestEvent variants to store state
    - `App.tsx` renders DropZone when idle, ProgressView when parsing, SummaryCard when complete, DropZone with error when errored
    - `pnpm tsc --noEmit` passes with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: DropZone, ProgressView, and SummaryCard components</name>
  <files>
    src/components/DropZone.tsx
    src/components/ProgressView.tsx
    src/components/SummaryCard.tsx
  </files>
  <action>
**Locked design decisions (from CONTEXT.md — do not deviate):**
- Always light — white/minimal background
- Drop zone: centered, dashed border, icon, single instruction line only: "Drop your ChatGPT export here"
- Browse link inside the zone (secondary affordance) — no separate button below
- Progress: stage label + spinner only — no byte counts, no file paths, no numbers
- Completion: "Found [N] conversations ([year] – [year])" + single Continue button
- Error: inline, adjacent to drop zone — zone resets immediately (no dedicated error screen)

**`src/components/DropZone.tsx`**:

```typescript
import { useEffect, useRef, useState } from 'react';
import { getCurrentWindow } from '@tauri-apps/api/window';
import { open } from '@tauri-apps/plugin-dialog';
import { Upload } from 'lucide-react';
import { useIngest } from '../hooks/useIngest';

interface DropZoneProps {
  errorMessage?: string;
  onReset?: () => void;
}

export function DropZone({ errorMessage, onReset }: DropZoneProps) {
  const { startIngest } = useIngest();
  const [isDragging, setIsDragging] = useState(false);
  const unlistenRef = useRef<(() => void) | null>(null);

  useEffect(() => {
    let mounted = true;

    getCurrentWindow()
      .onDragDropEvent((event) => {
        if (!mounted) return;

        if (event.payload.type === 'enter') {
          setIsDragging(true);
        } else if (event.payload.type === 'leave') {
          setIsDragging(false);
        } else if (event.payload.type === 'drop') {
          setIsDragging(false);
          // CRITICAL: Use Tauri's payload.paths — NOT HTML5 dataTransfer (gives no paths in Tauri)
          const paths: string[] = event.payload.paths ?? [];
          const zipPath = paths.find((p) => p.toLowerCase().endsWith('.zip'));
          if (zipPath) {
            startIngest(zipPath);
          } else if (paths.length > 0) {
            // Non-ZIP file dropped (e.g., Safari auto-unzipped folder)
            // Error handled by parent — show inline message
          }
        }
      })
      .then((unlisten) => {
        unlistenRef.current = unlisten;
      });

    return () => {
      mounted = false;
      unlistenRef.current?.();
    };
  }, [startIngest]);

  const handleBrowse = async () => {
    const path = await open({
      multiple: false,
      directory: false,
      filters: [{ name: 'ChatGPT Export', extensions: ['zip'] }],
    });
    if (path) {
      startIngest(path as string);
    }
  };

  return (
    <div className="flex flex-col items-center gap-4 w-full max-w-sm px-6">
      {/* Drop zone */}
      <div
        className={[
          'w-full rounded-xl border-2 border-dashed transition-colors duration-150',
          'flex flex-col items-center justify-center gap-3 py-12 px-6',
          isDragging
            ? 'border-neutral-400 bg-neutral-50'
            : 'border-neutral-300 bg-white',
        ].join(' ')}
      >
        {/* Icon — at Claude's discretion for exact style */}
        <Upload
          className={`w-10 h-10 ${isDragging ? 'text-neutral-500' : 'text-neutral-400'}`}
          strokeWidth={1.5}
        />

        {/* Single instruction line — exact copy locked in CONTEXT.md */}
        <p className="text-sm text-neutral-500 text-center leading-snug">
          Drop your ChatGPT export here
        </p>

        {/* Browse link — secondary affordance inside the zone */}
        <button
          onClick={handleBrowse}
          className="text-xs text-neutral-400 underline underline-offset-2 hover:text-neutral-600 transition-colors"
        >
          or browse for file
        </button>
      </div>

      {/* Inline error — shown adjacent to zone; zone stays interactive (IMP-05 + locked decision) */}
      {errorMessage && (
        <p className="text-sm text-red-500 text-center leading-snug">
          {errorMessage}
          {onReset && (
            <button
              onClick={onReset}
              className="ml-2 underline text-red-400 hover:text-red-600"
            >
              Try again
            </button>
          )}
        </p>
      )}
    </div>
  );
}
```

**`src/components/ProgressView.tsx`**:

```typescript
interface ProgressViewProps {
  stage: string;
}

export function ProgressView({ stage }: ProgressViewProps) {
  return (
    <div className="flex flex-col items-center gap-4">
      {/* Spinner — CSS animation, Claude's discretion on exact style */}
      <div className="w-8 h-8 rounded-full border-2 border-neutral-200 border-t-neutral-500 animate-spin" />
      {/* Stage label — human-readable, no jargon, no numbers (locked decision) */}
      <p className="text-sm text-neutral-500">{stage}</p>
    </div>
  );
}
```

**`src/components/SummaryCard.tsx`**:

```typescript
interface SummaryCardProps {
  total: number;
  earliestYear: number;
  latestYear: number;
  onContinue: () => void;
}

export function SummaryCard({
  total,
  earliestYear,
  latestYear,
  onContinue,
}: SummaryCardProps) {
  const yearRange =
    earliestYear === latestYear
      ? String(earliestYear)
      : `${earliestYear} – ${latestYear}`;

  return (
    <div className="flex flex-col items-center gap-6 text-center px-6">
      {/* Summary — exact format from locked decision: "Found [N] conversations ([year range])" */}
      <div>
        <p className="text-2xl font-medium text-neutral-800">
          Found {total.toLocaleString()} conversation{total !== 1 ? 's' : ''}
        </p>
        <p className="text-sm text-neutral-400 mt-1">{yearRange}</p>
      </div>

      {/* Single prominent Continue button — locked decision */}
      <button
        onClick={onContinue}
        className="px-8 py-2.5 rounded-lg bg-neutral-900 text-white text-sm font-medium hover:bg-neutral-700 transition-colors"
      >
        Continue
      </button>
    </div>
  );
}
```
  </action>
  <verify>
    <automated>cd /Users/darrellwhitelaw/Claude/chatgpt-to-claude && pnpm tsc --noEmit 2>&1 | grep "error TS" | head -10</automated>
    <manual>Zero TypeScript errors across all three component files</manual>
  </verify>
  <done>
    - DropZone uses `getCurrentWindow().onDragDropEvent()` for drop detection (NOT HTML5 onDrop)
    - DropZone has dashed border, Upload icon, single instruction line, Browse link inside zone
    - Browse link calls `@tauri-apps/plugin-dialog` `open()` with zip extension filter
    - Inline error appears below drop zone; zone remains interactive (no dedicated error screen)
    - ProgressView shows stage label and spinner — no byte counts, no numbers
    - SummaryCard shows "Found [N] conversations ([year] – [year])" with Continue button
    - Always light theme — white background throughout
    - `pnpm tsc --noEmit` passes with no errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of complete Phase 1 import flow</name>
  <action>Run `pnpm tauri dev` and manually verify the complete import flow: drag-and-drop, file picker, progress stages, summary card, error handling, and visual light theme. All behavior must match locked design decisions from CONTEXT.md.</action>
  <verify><automated>cd /Users/darrellwhitelaw/Claude/chatgpt-to-claude && pnpm tsc --noEmit && cargo check --manifest-path src-tauri/Cargo.toml</automated></verify>
  <done>Human approves all visual and behavioral checks described in how-to-verify steps</done>
  <what-built>
    Complete Phase 1 UI: drag-and-drop import, file picker fallback, three-stage progress display, and summary card.
    Run `pnpm tauri dev` to launch the app.
  </what-built>
  <how-to-verify>
    1. Run `pnpm tauri dev` from the project root
    2. Confirm the window opens at ~600x500, centered, not resizable
    3. Confirm the drop zone is visible: centered, dashed border, icon, "Drop your ChatGPT export here" text, "or browse for file" link
    4. Confirm the background is white/light — no dark mode elements
    5. Drag a ChatGPT export ZIP onto the drop zone → should enter parsing state showing a spinner and stage labels ("Extracting ZIP...", "Parsing conversations...", "Building index...")
    6. Confirm stage labels are human-readable with no byte counts, no file paths, no numbers during progress
    7. After parsing: confirm summary card shows "Found [N] conversations ([year] – [year])"
    8. Confirm Continue button is present (clicking it logs to console — Phase 2 behavior)
    9. Click "or browse for file" → confirm native macOS file picker opens filtered to .zip files
    10. Drop a non-ZIP file → confirm the drop zone remains intact and shows an inline error (does not navigate away)

    If you do not have a ChatGPT export on hand, test steps 3-8 can be simulated by:
    - Confirming the drag-over visual state activates (drop zone border changes on hover)
    - Using the Browse link to select any ZIP file available on disk
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any visual or behavioral issues</resume-signal>
</task>

</tasks>

<verification>
```bash
cd /Users/darrellwhitelaw/Claude/chatgpt-to-claude
pnpm tsc --noEmit
cargo check --manifest-path src-tauri/Cargo.toml
```
Both must exit 0 before the human-verify checkpoint.
</verification>

<success_criteria>
- Drop zone uses Tauri `onDragDropEvent` — NOT HTML5 onDrop (IMP-01)
- File picker uses `@tauri-apps/plugin-dialog` open() with zip filter (IMP-02)
- Progress shows stage labels + spinner — no byte counts, no numbers (IMP-03)
- Always light theme — white background, no dark mode (locked decision)
- Drop zone: centered, dashed border, icon, single instruction line, Browse link inside zone (locked decision)
- Completion card: "Found [N] conversations ([year] – [year])" + Continue button (locked decision)
- Error: inline, adjacent to zone, zone resets — no dedicated error screen (locked decision)
- `pnpm tsc --noEmit` and `cargo check` both pass
- Human checkpoint approved
</success_criteria>

<output>
After completion, create `.planning/phases/01-zip-parsing-foundation/01-04-SUMMARY.md` following the summary template.
</output>
